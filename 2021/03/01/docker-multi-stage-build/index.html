<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 4.2.1"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"amikai.github.io",root:"/",scheme:"Pisces",version:"7.8.0",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:"mac"},back2top:{enable:!0,sidebar:!1,scrollpercent:!1},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!0,lazyload:!0,pangu:!0,comments:{style:"tabs",active:"gitalk",storage:!0,lazyload:!1,nav:null,activeClass:"gitalk"},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"search.xml"}</script><meta name="description" content="docker 在專案部署上解掉了環境不同所多出的成本和問題。除了部署之外， 專案開發流程複雜時，團隊也可以使用 docker 統一開發流程，加速開發的速度。  此篇將以 go 語言專案為例，使用 docker 對此專案進行代碼檢查、測試、編譯，從建構最簡單的 Dockerfile 撰寫起，一步一步從版本一改善到版本三也就是 multi-stage build 的版本。 此檔案為最終完成版，並且可"><meta property="og:type" content="article"><meta property="og:title" content="Dockerfile -  Multi-stage build 筆記"><meta property="og:url" content="https://amikai.github.io/2021/03/01/docker-multi-stage-build/index.html"><meta property="og:site_name" content="no code no pain"><meta property="og:description" content="docker 在專案部署上解掉了環境不同所多出的成本和問題。除了部署之外， 專案開發流程複雜時，團隊也可以使用 docker 統一開發流程，加速開發的速度。  此篇將以 go 語言專案為例，使用 docker 對此專案進行代碼檢查、測試、編譯，從建構最簡單的 Dockerfile 撰寫起，一步一步從版本一改善到版本三也就是 multi-stage build 的版本。 此檔案為最終完成版，並且可"><meta property="og:locale" content="en_US"><meta property="article:published_time" content="2021-03-01T13:57:33.000Z"><meta property="article:modified_time" content="2021-03-01T14:30:43.930Z"><meta property="article:author" content="amikai"><meta property="article:tag" content="docker"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://amikai.github.io/2021/03/01/docker-multi-stage-build/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"en"}</script><title>Dockerfile - Multi-stage build 筆記 | no code no pain</title><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-172478407-1"></script><script>if(CONFIG.hostname===location.hostname){function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-172478407-1")}</script><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><link rel="alternate" href="/atom.xml" title="no code no pain" type="application/atom+xml"></head><body itemscope="" itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="Toggle navigation bar"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">no code no pain</h1><span class="logo-line-after"><i></i></span></a><p class="site-subtitle" itemprop="description">amikai notes</p></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul id="menu" class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i> Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i> About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i> Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i> Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i> Archives</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> Search</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocapitalize="off" placeholder="Searching..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"><div id="no-result"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div> <a href="https://github.com/amikai" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener noreferrer" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content post posts-expand"><article itemscope="" itemtype="http://schema.org/Article" class="post-block" lang="en"><link itemprop="mainEntityOfPage" href="https://amikai.github.io/2021/03/01/docker-multi-stage-build/"><span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.JPEG"><meta itemprop="name" content="amikai"><meta itemprop="description" content=""></span><span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="no code no pain"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> Dockerfile - Multi-stage build 筆記</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">Posted on</span> <time title="Created: 2021-03-01 21:57:33 / Modified: 22:30:43" itemprop="dateCreated datePublished" datetime="2021-03-01T21:57:33+08:00">2021-03-01</time></span><span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">Views:</span><span id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body" itemprop="articleBody"><p> docker 在專案部署上解掉了環境不同所多出的成本和問題。除了部署之外， 專案開發流程複雜時，團隊也可以使用 docker 統一開發流程，加速開發的速度。</p><p> 此篇將以 go 語言專案為例，使用 docker 對此專案進行代碼檢查、測試、編譯，從建構最簡單的 Dockerfile 撰寫起，一步一步從版本一改善到版本三也就是 multi-stage build 的版本。</p><p>此檔案為最終完成版，並且可以透過 git 記錄看到版本一和版本二的內容。<br> <a href="/2021/03/01/docker-multi-stage-build/example.tar.gz" title="example.tar.gz">example.tar.gz</a></p><p> sha256sum<br></p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">5321e3a3d67195f7c44f7c1e76ca229717fcd49ebb3359528038745670f68aba  example.tar.gz</span><br></pre></td></tr></tbody></table></figure><p></p><p>Note: 詳細實驗環境就放在最後<br><a id="more"></a></p><h1 id="範例-go-專案"><a href="#範例-go-專案" class="headerlink" title="範例 go 專案"></a>範例 go 專案</h1><p>此專案使用 gin 實作 http server 只要對它請求 <code>GET /ping</code> ，則會回覆 pong</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; tree example</span><br><span class="line">example</span><br><span class="line">├── go.mod</span><br><span class="line">├── go.sum</span><br><span class="line">├── main.go</span><br><span class="line">└── main_test.go</span><br></pre></td></tr></tbody></table></figure><p>go.mod</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">module example.com</span><br><span class="line"></span><br><span class="line">go 1.16</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure><p>main.go</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import "github.com/gin-gonic/gin"</span><br><span class="line"></span><br><span class="line">func setupRouter() *gin.Engine {</span><br><span class="line">	r := gin.Default()</span><br><span class="line">	r.GET("/ping", func(c *gin.Context) {</span><br><span class="line">		c.String(200, "pong")</span><br><span class="line">	})</span><br><span class="line">	return r</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">func main() {</span><br><span class="line">	r := setupRouter()</span><br><span class="line">	r.Run(":8080")</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>main_test.go</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	"net/http"</span><br><span class="line">	"net/http/httptest"</span><br><span class="line">	"testing"</span><br><span class="line"></span><br><span class="line">	"github.com/stretchr/testify/assert"</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func TestPingRoute(t *testing.T) {</span><br><span class="line">	router := setupRouter()</span><br><span class="line"></span><br><span class="line">	w := httptest.NewRecorder()</span><br><span class="line">	req, _ := http.NewRequest("GET", "/ping", nil)</span><br><span class="line">	router.ServeHTTP(w, req)</span><br><span class="line"></span><br><span class="line">	assert.Equal(t, 200, w.Code)</span><br><span class="line">	assert.Equal(t, "pong", w.Body.String())</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>在完成程式碼撰寫之後，會手動做以下動作，在下個段落，我將會將這個步驟改寫成 Dockerfile</p><ol><li>使用 go vet 檢查</li><li>使用 staticcheck 檢查</li><li>跑完測試</li><li>編譯專案</li><li>執行</li></ol><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ go vet ./...</span><br><span class="line">$ staticcheck ./...</span><br><span class="line">$ go test ./...</span><br><span class="line">$ go build -o ./server</span><br><span class="line">$ ./server</span><br></pre></td></tr></tbody></table></figure><h1 id="Dockerfile-版本一"><a href="#Dockerfile-版本一" class="headerlink" title="Dockerfile 版本一"></a>Dockerfile 版本一</h1><figure class="highlight dockerfile"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> golang:<span class="number">1.16</span>.<span class="number">0</span>-alpine3.<span class="number">13</span></span><br><span class="line"><span class="comment"># go module</span></span><br><span class="line"><span class="keyword">ENV</span> GO111MODULE=on CGO_ENABLED=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># install staticcheck binary</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> go install honnef.co/go/tools/cmd/staticcheck@v0.1.2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /workspace/example</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># download dependency</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> go.mod go.sum .</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash">  go mod download</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Copy source code</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> . ./</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> go vet ./... &amp;&amp; staticcheck ./... &amp;&amp; go <span class="built_in">test</span> ./... &amp;&amp; go build -o /bin/server</span></span><br></pre></td></tr></tbody></table></figure><p>把 image 做出來</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker image build -t amikai/example:v1  .</span><br></pre></td></tr></tbody></table></figure><p>為了要對此專案進行代碼檢查和編譯，必須將相關工具以及依賴下載好，而這些依賴及工具都會佔用到空間，觀察 container 裡 <code>/go</code> (go 相關依賴) 就佔了 328.7 MB (使用 <code>du -sh /go</code> 觀察)，而整個 image 是 687 MB，image 大小還有相當大的改善空間。</p><h1 id="Dockerfile-版本二：維護兩個-dockerfile"><a href="#Dockerfile-版本二：維護兩個-dockerfile" class="headerlink" title="Dockerfile 版本二：維護兩個 dockerfile"></a>Dockerfile 版本二：維護兩個 dockerfile</h1><p>把版本一的 dockfile 拆成兩個階段思考：</p><ul><li>從 deploy 的階段來想：最後只要留下需要編譯後所產生的執行檔，其他相關的依賴和工具都是不必要的，編譯完後放在那只是佔位置。</li><li>從 build 的階段來想：為了確保每個人在代碼檢查以及編譯的環境是統一的，減少環境不同所造成的問題。</li></ul><p>把這兩個階段的事情，拆成兩個 image file：</p><ul><li>Deploy 階段 (Dockerfile)：此在意的是 image 大小，所以留下編譯後的執行檔即可。</li><li>Build 階段 (Dockerfile.build)：此階段是對原始碼進行檢查及編譯等等，不太需要考慮 image 大小，反正不會拿去部署。</li></ul><p>具體的做法就是先做出一個 <code>Dockerfile.build</code> 去 build 出執行檔，把此執行檔取出，再寫一個 <code>Dockerfile</code> 將此執行檔放入，開始執行。在使用一個 <code>build.sh</code> 將上述事情自動化</p><p>Dockerfile.build</p><figure class="highlight docker"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> golang:<span class="number">1.16</span>.<span class="number">0</span>-alpine3.<span class="number">13</span></span><br><span class="line"><span class="comment"># go module</span></span><br><span class="line"><span class="keyword">ENV</span> GO111MODULE=on CGO_ENABLED=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># install staticcheck binary</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> go install honnef.co/go/tools/cmd/staticcheck@v0.1.2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /workspace/example</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># download dependency</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> go.mod go.sum .</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash">  go mod download</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Copy source code</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> . ./</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> go vet ./... &amp;&amp; staticcheck ./... &amp;&amp; go <span class="built_in">test</span> ./... &amp;&amp; go build -o /bin/server</span></span><br></pre></td></tr></tbody></table></figure><p>Dockerfile</p><figure class="highlight dockerfile"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> alpine:latest</span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /root/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> server .</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">"./server"</span>]</span></span><br></pre></td></tr></tbody></table></figure><p>build.sh</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">echo Building amikai/example:build</span><br><span class="line"></span><br><span class="line">docker build -t amikai/example:build . -f Dockerfile.build</span><br><span class="line">docker container create --name extract amikai/example:build </span><br><span class="line">docker container cp extract:/bin/server ./server</span><br><span class="line">docker container rm -f extract</span><br><span class="line"></span><br><span class="line">echo Building amikai/example:v2</span><br><span class="line">docker image build --no-cache -t amikai/example:v2  .</span><br></pre></td></tr></tbody></table></figure><p>執行 build.sh 將 example:v2 的 image 做出來，這個 image 大小是 15 MB，已經和版本一的 687 MB 有很大的進步空間。</p><p>雖然最終產出的 image 大小有極大的改善，但為了這個 image，必須維護三個檔案，在微服務的世界裡，如果一個 container 裝一個服務，就必須維護 服務數量 * 3 的檔案。</p><p>而且是兩個 image 分別都會佔用到硬碟空間，也就是說雖然拿來 deploy 的 image 改善了大小，但總體佔用的硬碟空間和版本一是幾乎一樣的。</p><h1 id="Dockerfile-版本三：-multi-stage-builds"><a href="#Dockerfile-版本三：-multi-stage-builds" class="headerlink" title="Dockerfile 版本三： multi-stage builds"></a>Dockerfile 版本三： multi-stage builds</h1><p>docker 在 17.05 提出 multi-stage builds，整個 dockerfile 可以分割成好幾個 stage，每個 stage 由 <code>FROM</code> 作為開始，也就是說 <code>FROM</code> 除了選擇基底 image 之外，還有新 stage 起始的意義。</p><p>multi-stage 功能讓我們可以將此 stage 所需要的檔案，複製到下個 stage 做其他事，則最終做出來的 image 只會留下所需的檔案。</p><p>版本三的 dockerfile 如下，有兩個 stage:</p><ol><li>builder stage: 以 golang 為基底的 image，用來做原始碼檢查、測試，並且編譯出執行檔</li><li>release stage: 將 builder stage 的執行檔複製過來，並且執行</li></ol><figure class="highlight dockerfile"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> golang:<span class="number">1.16</span>.<span class="number">0</span>-alpine3.<span class="number">13</span> AS builder</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /workspace/example</span></span><br><span class="line"><span class="keyword">ENV</span> GO111MODULE=on CGO_ENABLED=<span class="number">0</span></span><br><span class="line"><span class="comment"># download dependency</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> go.mod go.sum .</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash">  go mod download</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> go install honnef.co/go/tools/cmd/staticcheck@v0.1.2</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> . .</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> go vet ./... &amp;&amp; staticcheck ./... &amp;&amp; go <span class="built_in">test</span> ./... &amp;&amp; go build -o /bin/server</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> alpine:latest AS release</span><br><span class="line"><span class="comment"># Copy from builder</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=builder /bin/server /bin/server</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">"./bin/server"</span>]</span></span><br></pre></td></tr></tbody></table></figure><p>把 image 做出來</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker image build -t amikai/example:v3  .</span><br></pre></td></tr></tbody></table></figure><p>版本三的 image 大小為 15 MB，解決了版本二不需要維護三個檔案也解決了版本一產出肥大 image 的痛點。multi-stage builds 真是個有感的功能呀。</p><h1 id="詳細實驗環境"><a href="#詳細實驗環境" class="headerlink" title="詳細實驗環境"></a>詳細實驗環境</h1><p>golang</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> $ go version</span><br><span class="line">go version go1.16 darwin/amd64</span><br></pre></td></tr></tbody></table></figure><p>docker</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"> $ docker version</span><br><span class="line">Client: Docker Engine - Community</span><br><span class="line"> Cloud integration: 1.0.7</span><br><span class="line"> Version:           20.10.2</span><br><span class="line"> API version:       1.41</span><br><span class="line"> Go version:        go1.13.15</span><br><span class="line"> Git commit:        2291f61</span><br><span class="line"> Built:             Mon Dec 28 16:12:42 2020</span><br><span class="line"> OS/Arch:           darwin/amd64</span><br><span class="line"> Context:           default</span><br><span class="line"> Experimental:      true</span><br><span class="line"></span><br><span class="line">Server: Docker Engine - Community</span><br><span class="line"> Engine:</span><br><span class="line">  Version:          20.10.2</span><br><span class="line">  API version:      1.41 (minimum version 1.12)</span><br><span class="line">  Go version:       go1.13.15</span><br><span class="line">  Git commit:       8891c58</span><br><span class="line">  Built:            Mon Dec 28 16:15:28 2020</span><br><span class="line">  OS/Arch:          linux/amd64</span><br><span class="line">  Experimental:     false</span><br><span class="line"> containerd:</span><br><span class="line">  Version:          1.4.3</span><br><span class="line">  GitCommit:        269548fa27e0089a8b8278fc4fc781d7f65a939b</span><br><span class="line"> runc:</span><br><span class="line">  Version:          1.0.0-rc92</span><br><span class="line">  GitCommit:        ff819c7e9184c13b7c2607fe6c30ae19403a7aff</span><br><span class="line"> docker-init:</span><br><span class="line">  Version:          0.19.0</span><br><span class="line">  GitCommit:        de40ad0</span><br><span class="line"> Kubernetes:</span><br><span class="line">  Version:          v1.16.15-gke.7800</span><br><span class="line">  StackAPI:         Unknown</span><br></pre></td></tr></tbody></table></figure><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul><li><a href="https://docs.docker.com/develop/develop-images/multistage-build/" target="_blank" rel="noopener noreferrer">https://docs.docker.com/develop/develop-images/multistage-build/</a></li><li><a href="https://tachingchen.com/tw/blog/building-minimal-docker-image-for-go-applications/" target="_blank" rel="noopener noreferrer">打造最小 Go Docker Image</a></li><li><a href="https://blog.alexellis.io/mutli-stage-docker-builds/" target="_blank" rel="noopener noreferrer">https://blog.alexellis.io/mutli-stage-docker-builds/</a></li><li><a href="https://www.docker.com/blog/tag/go-env-series/" target="_blank" rel="noopener noreferrer">https://www.docker.com/blog/tag/go-env-series/</a></li><li><a href="https://github.com/moby/buildkit/blob/master/frontend/dockerfile/docs/syntax.md" target="_blank" rel="noopener noreferrer">https://github.com/moby/buildkit/blob/master/frontend/dockerfile/docs/syntax.md</a></li><li><a href="https://www.ctl.io/developers/blog/post/more-docker-image-cache-tips/" target="_blank" rel="noopener noreferrer">https://www.ctl.io/developers/blog/post/more-docker-image-cache-tips/</a></li></ul></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/docker/" rel="tag"># docker</a></div><div class="post-nav"><div class="post-nav-item"><a href="/2020/11/28/vim-c-env-move/" rel="prev" title="在 (neo)vim 裡 C 語言程式碼導覽技巧"><i class="fa fa-chevron-left"></i> 在 (neo)vim 裡 C 語言程式碼導覽技巧</a></div><div class="post-nav-item"></div></div></footer></article></div><div class="comments" id="gitalk-container"></div><script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> Table of Contents</li><li class="sidebar-nav-overview"> Overview</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#範例-go-專案"><span class="nav-number">1.</span> <span class="nav-text">範例 go 專案</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Dockerfile-版本一"><span class="nav-number">2.</span> <span class="nav-text">Dockerfile 版本一</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Dockerfile-版本二：維護兩個-dockerfile"><span class="nav-number">3.</span> <span class="nav-text">Dockerfile 版本二：維護兩個 dockerfile</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Dockerfile-版本三：-multi-stage-builds"><span class="nav-number">4.</span> <span class="nav-text">Dockerfile 版本三： multi-stage builds</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#詳細實驗環境"><span class="nav-number">5.</span> <span class="nav-text">詳細實驗環境</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Reference"><span class="nav-number">6.</span> <span class="nav-text">Reference</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="amikai" src="/images/avatar.JPEG"><p class="site-author-name" itemprop="name">amikai</p><div class="site-description" itemprop="description"></div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">10</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">1</span> <span class="site-state-item-name">categories</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">5</span> <span class="site-state-item-name">tags</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/amikai" title="GitHub → https://github.com/amikai" rel="noopener noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:as23041248@gmail.com" title="E-Mail → mailto:as23041248@gmail.com" rel="noopener noreferrer" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> © <span itemprop="copyrightYear">2021</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">amikai</span></div><div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener noreferrer" target="_blank">Hexo</a> &amp; <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener noreferrer" target="_blank">NexT.Pisces</a></div><div class="busuanzi-count"><script async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="Total Views"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer></div><script src="/lib/anime.min.js"></script><script src="//cdn.jsdelivr.net/npm/medium-zoom@1/dist/medium-zoom.min.js"></script><script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script><script src="//cdn.jsdelivr.net/npm/pangu@4/dist/browser/pangu.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script src="/js/local-search.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css"><script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : 'a7fb427a2efcda5f9e1e',
      clientSecret: '4553b6babb44ed8fbe989a20ea43655bdc344bbf',
      repo        : 'amikai.github.io',
      owner       : 'amikai',
      admin       : ['amikai'],
      id          : 'e6eaca857a2ac0b0c30e2d5b79d7aaa7',
        language: 'en',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script></body></html>